#!/bin/bash

DO_TEST="./do_test"

while : ; do
  case "$1" in
    "") break;;
    -makefile)
        DO_TEST="$DO_TEST -makefile";;
    -compiler)
        DO_TEST="$DO_TEST -compiler $2"; shift;;
    -help)
        cat <<EOF
Usage: do_tests [options] kind subdir
where
options: [defaults in brackets after descriptions]
  -makefile              (re)build makefile in test directories [default: no]
  -compiler path         path to the rfsmc compiler [default: $RFSMC]
  -show                  launch DOT or VCD viewer after running the test [default: no]
  -help                  print this message
kind=dot|sim|ctask|systemc|vhdl|systemc.code|vhdl.code|systemc.sim|vhdl.sim
subdir=full|others/core|...
EOF
	exit 0;;
    *) break;;
  esac
  shift
done

#echo "DO_TEST=$DO_TEST 1=$1 2=$2"

run ()
{
nt=0
ns=0
for i in $2/tests/{single,multi}/[a-z]*
do
    if [ -e $i ]; then
        (( nt = nt + 1 ))
        $DO_TEST $1 $i
        (( ns = ns + $? ));
    fi
done
echo "***" $ns"/"$nt "test(s) OK"
}

SUBDIRS="others/core others/simple others/szdints others/szvars full"

case $2 in
    all) 
        for i in $SUBDIRS
        do
            run $1 $i
        done;;
    *)
        run $1 $2;;
esac
