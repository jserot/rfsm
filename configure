#!/bin/bash

configure_options="$*"
platform=unix
arch=macosx64
native='yes'
dotprogram='dot'
dotviewer='graphviz'
vcdviewer='gtkwave'
txtviewer='nano'
install_bindir=''
install_libdir=''
install_docdir=''
install_mandir=''

ocamlversion_min=4.06

# Parse command-line arguments

while : ; do
  case "$1" in
    "") break;;
    -platform|--platform)
        platform=$2; shift;;
    -bindir|--bindir)
        install_libdir=$2; shift;;
    -libdir|--libdir)
        install_libdir=$2; shift;;
    -docdir|--docdir)
        install_docdir=$2; shift;;
    -mandir|--mandir)
        install_mandir=$2; shift;;
    -byte-only|--byte-only)
        native='no'; shift;;
    -dot|--dot)
        dotprogram=$2; shift;;
    -dotviewer|--dotviewer)
        dotviewer=$2; shift;;
    -vcdviewer|--vcdviewer)
        vcdviewer=$2; shift;;
    -txtviewer|--txtviewer)
        txtviewer=$2; shift;;
    -help|--help)
        cat <<EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]
  --platform NAME         target platform (unix, macos or win32) [default: unix]
  --bindir DIR            install  executables in DIR [default: $install_bindir]
  --libdir DIR            install libraries in in DIR [default: $install_libdir]
  --docdir DIR            install documentation in DIR [default: $install_docdir]
  --mandir DIR            install man documentation in DIR [default:$install_mandir]
  --byte-only             do not build native code executable
  --dot NAME              command for runing dot program [default: $dotprogram]
  --dotviewer NAME        command for displaying .dot files [default: $dotviewer]
  --vcdviewer NAME        command for displaying .vcd files [default: $vcdviewer]
  --txtviewer NAME        command for displaying text files [default: $txtviewer]
  --help                  print this message
EOF
	exit 0;;
    *) echo "Unknown option \"$1\"." 1>&2; exit 2;;
  esac
  shift
done

case "$platform" in
  win32)
      if [ -z "$install_bindir" ]; then install_bindir='./build/bin'; fi;
      if [ -z "$install_mandir" ]; then install_bindir='./build/man'; fi;
      if [ -z "$install_libdir" ]; then install_libdir='./build/lib'; fi;
      if [ -z "$install_docdir" ]; then install_docdir='./build/doc'; fi;;
  *) 
      if [ -z "$install_bindir" ]; then install_bindir='/usr/local/bin'; fi;
      if [ -z "$install_mandir" ]; then install_bindir='/usr/local/man/man1'; fi;
      if [ -z "$install_libdir" ]; then install_libdir=`opam config var lib`; fi;
      if [ -z "$install_docdir" ]; then install_docdir=`opam config var doc`; fi;;
esac


# Generate the config file

rootdir=`dirname $0`

cd $rootdir
rm -f config
touch config

# Write options

version=`cat VERSION`
echo "# generated by ./configure $configure_options" >> config
echo "PLATFORM=$platform" >> config
echo "$version" >> config
echo "BUILD_NATIVE=$native" >> config
echo "" >> config
echo "# INSTALL PATHS" >> config
echo "INSTALL_BINDIR=$install_bindir" >> config
echo "INSTALL_LIBDIR=$install_libdir" >> config
echo "INSTALL_DOCDIR=$install_docdir" >> config
echo "INSTALL_MANDIR=$install_mandir" >> config

# Finish generated files

echo "# LOCAL PATHS" >> config
pwd=`pwd`
echo "RFSMC=$pwd/src/compiler/main.byte" >> config
echo "LIBDIR=$pwd/lib" >> config
echo "DOT=$dotprogram" >> config
echo "DOTVIEWER=$dotviewer" >> config
echo "VCDVIEWER=$vcdviewer" >> config
echo "TXTVIEWER=$txtviewer" >> config

touch ./config-stamp

echo
echo "** Configuration summary **"
echo
echo "Directory where the distribution will be installed:"
echo "        binaries................   $install_bindir"
echo "        library.................   $install_libdir"
echo "        documentation............. $install_docdir"
echo "        man pages................. $install_mandir"
if [ -n "$dotprogram" ]; then
echo "Command for viewing .dot files: \"$dotprogram\""
fi
if [ -n "$dotviewer" ]; then
echo "Command for viewing .dot files: \"$dotviewer\""
fi
if [ -n "$vcdviewer" ]; then
echo "Command for viewing .vcd files: \"$vcdviewer\""
fi
if [ -n "$txtviewer" ]; then
echo "Command for viewing text files: \"$txtviewer\""
fi
echo
echo "** Configuration completed successfully **"
echo "** Wrote files ./config and ./lib/etc/config"
echo

cp config ./lib/etc
