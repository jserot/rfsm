#!/bin/bash

libdir=`opam var share`/rfsm
main='main'
with_test_targets=''
project_file=''
generated_file='Makefile'
options="$*"
confirm='yes'
rfsmc='rfsmc'

# Parse command-line arguments

while : ; do
  case "$1" in
    "") break;;
    -main)
        main=$2; shift;;
    -lib)
        libdir=$2; shift;;
    -o)
        generated_file=$2; shift;;
    -with-test-targets)
        with_test_targets='yes';;
    -no-confirm)
        confirm='no';;
    -compiler)
        rfsmc=$2; shift;;
    -help)
        cat <<EOF
Usage: rfsmmake [options] project_file
Options: [defaults in brackets after descriptions]
  -main MAIN             set name of main taregt [default: 'main']
  -lib LIBDIR            set location of RFSM library [default: '$libdir]
  -o FILE                set name of the generated Makefile [default: 'Makefile']
  -with-test-targets     generated test targets [default: no]
  -no-confirm            do not ask confirmation before overwriting existing Makefile [default is to ask]
  -compiler              set path to the rfsmc compiler
  -help                  print this message
EOF
	exit 0;;
    -*) echo "Unknown option \"$1\"." 1>&2; exit 2;;
    *) project_file=$1;;
  esac
  shift
done

go="no"
if [[ $confirm = "yes" ]]; then
    if [ -e $generated_file ]; then
        echo "File $generated_file already exists. Overwrite (yes|no) ?"
        read go
    fi
else
    go="yes"
fi

if [[ $go = "yes" ]]; then
    echo "# generated by rfsmmake $options" > $generated_file
    echo "" >> $generated_file
    echo "include $libdir/platform" >> $generated_file
    echo "" >> $generated_file
    echo "LIBDIR=$libdir" >> $generated_file
    echo "" >> $generated_file
    echo "" >> $generated_file
    echo "RFSMC=$rfsmc" >> $generated_file
    cat $project_file >> $generated_file
    echo "" >> $generated_file
    cat $libdir/templates/Makefile.templ >> $generated_file
    if [ -n "$with_test_targets" ]; then
        echo "" >> $generated_file
        cat $libdir/templates/Makefile.test.templ >> $generated_file
    fi
    echo "Wrote $generated_file"
fi

